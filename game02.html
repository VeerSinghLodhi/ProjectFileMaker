<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thyeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Casino Game - HotOrNot</title>
  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    .back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #FA8231, #F97F51);
        border: 3px solid #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(250, 130, 49, 0.5);
        transition: all 0.3s ease;
        z-index: 1000;
        text-decoration: none;
        color: white;
        font-size: 24px;
    }

    .back-button:hover {
        transform: translateX(-5px) scale(1.1);
        box-shadow: 0 6px 20px rgba(250, 130, 49, 0.7);
        color: white;
    }

    @media (max-width: 480px) {
        .back-button {
            width: 40px;
            height: 40px;
            font-size: 20px;
            top: 15px;
            left: 15px;
        }
    }

    .casino-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px 10px;
        min-height: 500px;
    }

    #casinoResult {
        font-size: 20px;
        font-weight: bold;
        color: #FFD700;
        margin-bottom: 20px;
        text-shadow: 2px 2px 6px #000;
        text-align: center;
        min-height: 30px;
    }

    @media (max-width: 480px) {
        #casinoResult {
            font-size: 16px;
            margin-bottom: 15px;
        }
    }

    .slot-machine {
        background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
        border: 8px solid gold;
        border-radius: 20px;
        padding: 30px 20px;
        box-shadow: 0 10px 40px rgba(255, 215, 0, 0.5);
        max-width: 450px;
        width: 100%;
    }

    @media (max-width: 480px) {
        .slot-machine {
            padding: 20px 15px;
            border-width: 6px;
        }
    }

    .slots-wrapper {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
    }

    @media (max-width: 480px) {
        .slots-wrapper {
            gap: 10px;
        }
    }

    .slot-column {
        background: linear-gradient(180deg, #fff 0%, #f0f0f0 100%);
        border: 4px solid #333;
        border-radius: 15px;
        width: 100px;
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    @media (max-width: 480px) {
        .slot-column {
            width: 80px;
            height: 100px;
            border-width: 3px;
        }
    }

    @media (min-width: 768px) {
        .slot-column {
            width: 120px;
            height: 140px;
        }
    }

    .slot-symbol {
        font-size: 60px;
        animation: none;
    }

    @media (max-width: 480px) {
        .slot-symbol {
            font-size: 48px;
        }
    }

    @media (min-width: 768px) {
        .slot-symbol {
            font-size: 70px;
        }
    }

    .slot-column.spinning .slot-symbol {
        animation: slot-spin 0.1s linear infinite;
    }

    @keyframes slot-spin {
        0% {
            transform: translateY(0);
        }

        100% {
            transform: translateY(-300%);
        }
    }

    .lever-btn {
        background: linear-gradient(135deg, #FA8231 0%, #F97F51 50%, #FF6B9D 100%);
        color: white;
        border: 3px solid #fff;
        font-weight: 900;
        font-size: 18px;
        cursor: pointer;
        padding: 15px 40px;
        border-radius: 50px;
        margin-top: 20px;
        box-shadow: 0 6px 25px rgba(250, 130, 49, 0.6);
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    @media (max-width: 480px) {
        .lever-btn {
            font-size: 16px;
            padding: 12px 30px;
        }
    }

    .lever-btn:hover:not(:disabled) {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 35px rgba(250, 130, 49, 0.8);
    }

    .lever-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    #casinoResult1 {
        margin-top: 20px;
        font-size: 18px;
        font-weight: bold;
        color: #FFD700;
        text-shadow: 2px 2px 6px #000;
        text-align: center;
    }

    @media (min-width: 768px) {
        #casinoResult1 {
            font-size: 22px;
        }
    }

    .confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        background: #ffd700;
        animation: confetti-fall 3s linear;
        pointer-events: none;
    }

    @keyframes confetti-fall {
        to {
            transform: translateY(100vh) rotate(360deg);
            opacity: 0;
        }
    }

    .firework {
        position: fixed;
        width: 4px;
        height: 4px;
        border-radius: 50%;
        animation: firework-burst 1s ease-out forwards;
        pointer-events: none;
    }

    @keyframes firework-burst {
        0% {
            transform: translate(0, 0);
            opacity: 1;
        }

        100% {
            transform: translate(var(--x), var(--y));
            opacity: 0;
        }
    }

    .celebration-text {
        position: fixed;
        font-size: 50px;
        font-weight: bold;
        color: #ffd700;
        text-shadow: 3px 3px 10px rgba(0, 0, 0, 0.5);
        animation: celebration-pop 2s ease-out forwards;
        pointer-events: none;
        z-index: 1000;
    }

    @media (min-width: 768px) {
        .celebration-text {
            font-size: 70px;
        }
    }

    @keyframes celebration-pop {
        0% {
            transform: scale(0) rotate(-10deg);
            opacity: 0;
        }

        50% {
            transform: scale(1.2) rotate(5deg);
            opacity: 1;
        }

        100% {
            transform: scale(1) rotate(0deg) translateY(-50px);
            opacity: 0;
        }
    }

    .points-shower {
        position: fixed;
        font-size: 24px;
        font-weight: bold;
        animation: points-fall 2s linear forwards;
        pointer-events: none;
        z-index: 999;
    }

    @media (min-width: 768px) {
        .points-shower {
            font-size: 30px;
        }
    }

    @keyframes points-fall {
        0% {
            transform: translateY(-50px) rotate(0deg);
            opacity: 1;
        }

        100% {
            transform: translateY(100vh) rotate(720deg);
            opacity: 0;
        }
    }

    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.4s ease;
    }

    .popup-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    .popup {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 248, 240, 0.95));
        padding: 30px 40px;
        border-radius: 25px;
        text-align: center;
        color: #2d2d2d;
        box-shadow: 0 10px 50px rgba(250, 130, 49, 0.4);
        border: 3px solid rgba(250, 130, 49, 0.3);
        position: relative;
        overflow: hidden;
        animation: popupScale 0.6s ease-out;
        max-width: 90%;
    }

    @media (min-width: 768px) {
        .popup {
            padding: 40px 60px;
        }
    }

    @keyframes popupScale {
        0% {
            transform: scale(0.8);
            opacity: 0;
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .badge-wrapper {
        position: relative;
        margin-bottom: 15px;
    }

    .badge {
        background: linear-gradient(135deg, #FA8231, #F97F51, #FF6B9D);
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        position: relative;
        box-shadow: 0 0 40px rgba(250, 130, 49, 0.6);
        animation: pulse 1.5s infinite;
    }

    @media (min-width: 768px) {
        .badge {
            width: 120px;
            height: 120px;
        }
    }

    .badge-text {
        font-size: 2em;
        font-weight: bold;
        color: #fff;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    @media (min-width: 768px) {
        .badge-text {
            font-size: 2.5em;
        }
    }

    .shine {
        position: absolute;
        top: 0;
        left: -75%;
        width: 50%;
        height: 100%;
        background: linear-gradient(120deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0));
        transform: skewX(-25deg);
        animation: shine 2s infinite;
    }

    @keyframes shine {
        0% {
            left: -75%;
        }

        100% {
            left: 125%;
        }
    }

    .points-earned {
        font-size: 1.1em;
        margin-top: 15px;
        color: #FA8231;
        font-weight: 700;
    }

    @media (min-width: 768px) {
        .points-earned {
            font-size: 1.2em;
        }
    }

    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.08);
        }
    }

    .close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 28px;
        color: #999;
        background: none;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 1001;
    }

    @media (min-width: 768px) {
        .close-btn {
            top: 15px;
            right: 20px;
            font-size: 32px;
        }
    }

    .close-btn:hover {
        color: #FA8231;
        transform: rotate(90deg);
    }

    .badge-circle-md {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }

    .main-container {
        padding-top: 80px;
    }
  </style>
</head>

<body>
<a href="javascript:history.back()" class="back-button">
  <i class="bi bi-arrow-left"></i>
</a>

<div class="main-container">
  <div class="card shadow-sm p-3 rounded-4">
    <h3 class="text-center mb-3 fw-bold text-danger">Casino Game</h3>
    <span class="badge bg-dark badge-circle-md" th:text="${casinoLimitCounter}"></span>
    <div class="casino-container">
      <div th:if="${casinoLimit==false}" id="casinoResult">Pull the lever! you have <span th:text="${casinoLimitCounter}" id="casinoChance"></span> Chances</div>
      <div th:if="${casinoLimit==true}" class="text-danger fw-bolder my-4">Your 3 pulls for this week are finished!</div>
      <div class="slot-machine">
        <div class="slots-wrapper">
          <div class="slot-column" id="slot1">
            <div class="slot-symbol">‚ù§Ô∏è</div>
          </div>
          <div class="slot-column" id="slot2">
            <div class="slot-symbol">üå∏</div>
          </div>
          <div class="slot-column" id="slot3">
            <div class="slot-symbol">üíç</div>
          </div>
        </div>
      </div>
      <button th:disabled="${casinoLimit} ? true : false" class="lever-btn" id="leverBtn" onclick="pullLever()">PULL LEVER</button>
      <div id="casinoResult1"></div>
    </div>
  </div>
</div>

<div class="popup-overlay" id="popupOverlay">
  <div class="popup">
    <button class="close-btn" onclick="closePopup()">&times;</button>
    <div class="badge-wrapper">
      <div class="badge">
        <div class="shine"></div>
        <div class="badge-text">+<span id="badgePoints">50</span></div>
      </div>
    </div>
    <div class="points-earned"><span id="pointsText">You earned 50 points!</span></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script>
  const casinoSymbols = ['‚ù§Ô∏è', 'üå∏', 'üíç'];
  let casinoSpinning = false;

  function createConfetti() {
    for (let i = 0; i < 100; i++) {
      setTimeout(() => {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * window.innerWidth + 'px';
        confetti.style.top = '-10px';
        confetti.style.background = ['#FF6B6B', '#4ECDC4', '#FFD93D', '#AA96DA', '#F38181', '#95E1D3'][Math.floor(Math.random() * 6)];
        confetti.style.width = (Math.random() * 10 + 5) + 'px';
        confetti.style.height = (Math.random() * 10 + 5) + 'px';
        document.body.appendChild(confetti);

        setTimeout(() => confetti.remove(), 3000);
      }, i * 20);
    }
  }

  function createFireworks() {
    const colors = ['#FF6B6B', '#4ECDC4', '#FFD93D', '#AA96DA', '#F38181', '#95E1D3'];

    for (let i = 0; i < 5; i++) {
      setTimeout(() => {
        const x = Math.random() * window.innerWidth;
        const y = Math.random() * (window.innerHeight * 0.5);

        for (let j = 0; j < 30; j++) {
          const firework = document.createElement('div');
          firework.className = 'firework';
          firework.style.left = x + 'px';
          firework.style.top = y + 'px';
          firework.style.background = colors[Math.floor(Math.random() * colors.length)];

          const angle = (Math.PI * 2 * j) / 30;
          const velocity = 50 + Math.random() * 100;

          firework.style.setProperty('--x', Math.cos(angle) * velocity + 'px');
          firework.style.setProperty('--y', Math.sin(angle) * velocity + 'px');

          document.body.appendChild(firework);
          setTimeout(() => firework.remove(), 1000);
        }
      }, i * 300);
    }
  }

  function createCelebrationText() {
    const messages = ['üéâ AMAZING! üéâ', '‚≠ê FANTASTIC! ‚≠ê', 'üî• ON FIRE! üî•', 'üí´ SPECTACULAR! üí´', 'üéä INCREDIBLE! üéä'];
    const message = messages[Math.floor(Math.random() * messages.length)];

    const celebText = document.createElement('div');
    celebText.className = 'celebration-text';
    celebText.textContent = message;
    celebText.style.left = '50%';
    celebText.style.top = '30%';
    celebText.style.transform = 'translateX(-50%)';

    document.body.appendChild(celebText);
    setTimeout(() => celebText.remove(), 2000);
  }

  function createPointsShower(points) {
    const colors = ['#FFD700', '#FFA500', '#FF6B6B', '#4ECDC4'];

    for (let i = 0; i < 20; i++) {
      setTimeout(() => {
        const el = document.createElement('div');
        el.className = 'points-shower';
        el.textContent = '+' + points;
        el.style.left = (Math.random() * window.innerWidth) + 'px';
        el.style.top = '-50px';
        el.style.color = colors[Math.floor(Math.random() * colors.length)];

        document.body.appendChild(el);
        setTimeout(() => el.remove(), 2000);
      }, i * 100);
    }
  }

  function closePopup() {
    document.getElementById('popupOverlay').classList.remove('show');
  }

  function getRandomSymbol() {
    return casinoSymbols[Math.floor(Math.random() * casinoSymbols.length)];
  }

  function animateSlot(slotElement, finalSymbol, duration) {
    const symbolEl = slotElement.querySelector('.slot-symbol');
    slotElement.classList.add('spinning');

    let elapsed = 0;
    const interval = setInterval(() => {
      symbolEl.textContent = getRandomSymbol();
      elapsed += 100;

      if (elapsed >= duration) {
        clearInterval(interval);
        slotElement.classList.remove('spinning');
        symbolEl.textContent = finalSymbol;
      }
    }, 100);

    return new Promise(resolve => setTimeout(resolve, duration));
  }

  function pullLever() {
    if (casinoSpinning) return;

    const slot1 = document.getElementById('slot1');
    const slot2 = document.getElementById('slot2');
    const slot3 = document.getElementById('slot3');
    const casinoResult = document.getElementById('casinoResult');
    const leverBtn = document.getElementById('leverBtn');

    casinoSpinning = true;
    leverBtn.disabled = true;
    casinoResult.innerText = "Spinning... üé∞";

    const final1 = getRandomSymbol();
    const final2 = getRandomSymbol();
    const final3 = getRandomSymbol();

    Promise.all([
      animateSlot(slot1, final1, 1000),
      animateSlot(slot2, final2, 1500),
      animateSlot(slot3, final3, 2000)
    ]).then(() => {
      let points = 0;
      let message = '';

      if (final1 === final2 && final2 === final3) {
        if (final1 === 'üíç') {
          points = 100;
          message = 'üíç JACKPOT! Triple Rings! üíç';
        } else if (final1 === '‚ù§Ô∏è') {
          points = 75;
          message = '‚ù§Ô∏è AMAZING! Triple Hearts! ‚ù§Ô∏è';
        } else {
          points = 50;
          message = 'üå∏ GREAT! Triple Flowers! üå∏';
        }
      } else if (final1 === final2 || final2 === final3 || final1 === final3) {
        points = 20;
        message = 'üéä Nice! Two matching symbols! üéä';
      } else {
        points = 5;
        message = '‚ú® Keep trying! Here are 5 points! ‚ú®';
      }

      casinoResult.innerHTML = `${message}<br><b>+${points} Points!</b>`;

      createConfetti();
      createFireworks();
      createCelebrationText();
      createPointsShower(points);
      saveRewardToServer(points, "CASINO");

      document.getElementById('badgePoints').textContent = points;
      document.getElementById('pointsText').textContent = `You earned ${points} points!`;
      document.getElementById('popupOverlay').classList.add('show');

      setTimeout(() => {
        casinoSpinning = false;
      }, 1000);
    });
  }

  function saveRewardToServer(reward, category) {
    const formData = new URLSearchParams();
    formData.append("reward", reward);
    formData.append("category", category);

    const csrfToken = document.querySelector("meta[name='_csrf']").content;
    const csrfHeader = document.querySelector("meta[name='_csrf_header']").content;

    const leverBtn = document.getElementById('leverBtn');

    fetch('/user/spinWheel', {
      method: 'POST',
      headers: {
        [csrfHeader]: csrfToken,
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: formData
    })
      .then(response => response.json())
      .then(res => {
        console.log("SERVER RESPONSE:", res);

        if (res.casinoSpins >= 2) {
          leverBtn.disabled = true;
        } else {
          leverBtn.disabled = false;
        }

        if (res.status === "limit") {
          if (category === "CASINO") leverBtn.disabled = true;
          return;
        }
      })
      .catch(err => {
        console.error("ERROR:", err);
        alert("Something went wrong!");
      });
  }
</script>

</body>
</html>